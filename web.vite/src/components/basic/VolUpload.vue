<template>
  <div class="upload-container">
    <div>
      <!-- style="margin-bottom: 10px" -->
      <div class="input-btns" style="display: flex">
        <input
          ref="input"
          type="file"
          style="display: none"
          @change="handleChange"
          :multiple="multiple"
        />
        <div v-if="img" class="upload-img">
          <!-- v-for="(file,index) in fileInfo.length>0?fileInfo: files" -->
          <div
            v-for="(file, index) in files"
            :key="index"
            :style="{ height: imgInfo.height + 'px', width: imgInfo.width + 'px' }"
            class="img-item"
          >
            <div class="operation">
              <div class="action">
                <i class="el-icon-view view" @click="previewImg(index)"></i>
                <i class="el-icon-delete remove" @click="removeFile(index)"></i>
              </div>
              <div class="mask"></div>
            </div>

            <img :src="getImgSrc(file, index) + access_token" @error="handleImageError" />
          </div>
          <div
            :style="{ height: imgInfo.height + 'px', width: imgInfo.width + 'px' }"
            v-show="!autoUpload || (autoUpload && files.length < maxFile)"
            class="img-selector"
            :class="getSelector()"
          >
            <div class="selector" @click="handleClick">
              <i
                :style="{ 'font-size': imgInfo.iconSize + 'px' }"
                :class="imgInfo.icon"
              ></i>
            </div>
            <div
              v-if="!autoUpload"
              class="s-btn"
              :class="{ readonly: changed }"
              @click="upload"
            >
              <div>{{ loadText }}</div>
            </div>
          </div>
        </div>
        <el-button v-else @click="handleClick">{{
          $ts("選擇" + (img ? "圖片" : "文件"))
        }}</el-button>

        <el-button
          v-if="!autoUpload && !img"
          type="info"
          :disabled="changed"
          @click="upload(true)"
          :loading="loadingStatus"
          >{{ $ts("上傳文件") }}</el-button
        >
      </div>
      <slot></slot>
      <div v-if="desc">
        <el-alert
          :title="getText() + '文件大小不超過' + (maxSize || 50) + 'M'"
          type="info"
          show-icon
        >
        </el-alert>
      </div>
      <slot name="content"></slot>
      <div v-if="!img">
        <ul class="upload-list" v-show="fileList">
          <li class="list-file" v-for="(file, index) in files" :key="index">
            <a>
              <span @click="fileOnClick(index, file)">
                <i :class="format(file)"></i>
                {{ file.name }}
              </span>
            </a>
            <span @click="removeFile(index)" class="file-remove">
              <i class="el-icon-close"></i>
            </span>
          </li>
        </ul>
      </div>
      <slot name="tip"></slot>
    </div>
    <vol-image-viewer ref="viewer"></vol-image-viewer>
  </div>
</template>
<script>
//import OSS from 'ali-oss'
const OSS = {};
import VolImageViewer from "./VolImageViewer.vue";
export default {
  components: {
    "vol-image-viewer": VolImageViewer,
  },
  props: {
    desc: {
      //是否顯示默認介绍
      //是否多選
      type: Boolean,
      default: false,
    },
    fileInfo: {
      //用於接收上傳的文件，也可以加以默認值，顯示已上傳的文件，用户上傳後會覆蓋默認值
      type: Array,
      default: () => {
        return [];
      }, //格式[{name:'1.jpg',path:'127.0.01/1.jpg'}]
    },
    downLoad: {
      //是否可以點擊文件下載
      type: Boolean,
      default: true,
    },
    multiple: {
      //是否多選
      type: Boolean,
      default: false,
    },
    maxFile: {
      //最多可選文件數量，必須multiple=true，才會生效
      type: Number,
      default: 5,
    },
    maxSize: {
      //文件限制大小3M
      type: Number,
      default: 50,
    },

    autoUpload: {
      //選擇文件後是否自動上傳
      type: Boolean,
      default: true,
    },
    img: {
      //圖片類型  img>excel>fileTypes三種文件類型優先级
      type: Boolean,
      default: false,
    },
    excel: {
      //excel文件
      type: Boolean,
      default: false,
    },
    fileTypes: {
      //指定上傳文件的類型
      type: Array,
      default: () => {
        return [];
      },
    },
    url: {
      //上傳的url
      type: String,
      default: "",
    },
    uploadBefore: {
      //返回false會中止執行
      //上傳前
      type: Function,
      default: (files) => {
        return true;
      },
    },
    uploadAfter: {
      //返回false會中止執行
      //上傳後
      type: Function,
      default: (result, files) => {
        return true;
      },
    },
    onChange: {
      //選擇文件時  //返回false會中止執行
      type: Function,
      default: (files) => {
        return true;
      },
    },
    // clear: {
    //   //上傳完成後是否清空文件列表
    //   type: Boolean,
    //   default: true
    // },
    fileList: {
      //是否顯示選擇的文件列表
      type: Boolean,
      default: true,
    },
    fileClick: {
      //點擊文件事件
      type: Function,
      default: (index, file, files) => {
        return true;
      },
    },
    removeBefore: {
      //移除文件事件
      type: Function,
      default: (index, file, files) => {
        return true;
      },
    },
    append: {
      //此屬性已废弃，多文件上傳，默認追加文件
      type: Boolean,
      default: false,
    },
    compress: {
      //開啟圖片压缩,後面根據需要再完善
      type: Boolean,
      default: false,
    },
    compressMinSize: {
      //压缩的最小比例
      type: Number,
      default: 0.1,
    },
    imgOption: {
      //圖片上傳信息
      type: Object,
      default: () => {
        return {
          //icon: "el-icon-camera",//上傳圖標
          //iconSize:40,//上傳圖標大小
          // height: 65, //圖片高度
          // width: 65,//圖片寬度
        };
      },
    },
  },
  data() {
    return {
      defaultImg: new URL("@/assets/imgs/error-img.png", import.meta.url).href,
      // errorImg: 'this.src="' + require('@/assets/imgs/error-img.png') + '"',
      changed: false, //手動上傳成功後禁止重複上傳，必須重新選擇
      model: true,
      files: [],
      bigImg: "",
      imgTypes: ["gif", "jpg", "jpeg", "png", "bmp", "webp", "jfif"],
      loadingStatus: false,
      loadText: "上傳文件",
      access_token: "",
      imgInfo: {
        icon: "el-icon-camera-solid",
        iconSize: 35,
        height: 65, //圖片高度
        width: 65, //圖片寬度
      },
    };
  },
  created() {
    Object.assign(this.imgInfo, this.imgOption);
    const tk = (this.$store.getters.getUserInfo() || { accessToken: "" }).accessToken;
    if (tk) {
      this.access_token = "?access_token=" + tk;
    }
    //默認有圖片的禁止上傳操作
    if (this.fileInfo) {
      this.changed = true;
    }
    this.cloneFile(this.fileInfo);
  },
  watch: {
    fileInfo: {
      handler(files) {
        this.cloneFile(files);
      },
      deep: true,
    },
  },
  methods: {
    cloneFile(files) {
      this.files = files.map((x) => {
        return {
          name: x.name || this.getFileName(x.path),
          path: x.path,
        };
      });
    },
    getFileName(path) {
      if (!path) {
        return "未定義文件名";
      }
      let _index = path.lastIndexOf("/");
      return path.substring(_index + 1);
    },
    previewImg(index) {
      const imgs = this.files.map((x) => {
        return this.getImgSrc(x) + this.access_token;
      });
      this.$refs.viewer.show(imgs, index);
      //  this.base.previewImg(this.getImgSrc(this.files[index]));
      //  window.open(this.getImgSrc((this.files.length>0?this.files:this.fileInfo)[index]));
    },
    getSelector() {
      if (this.autoUpload) {
        return "auto-selector";
      }
      return "submit-selector";
    },
    getImgSrc(file, index) {
      if (file.hasOwnProperty("path")) {
        if (this.base.isUrl(file.path)) {
          return file.path;
        }
        //2020.12.27增加base64圖片操作
        if (file.path.indexOf("/9j/") != -1) {
          return "data:image/jpeg;base64," + file.path;
        }
        if (file.path.substr(0, 1) == "/") {
          file.path = file.path.substr(1);
        }
        return this.http.ipAddress + file.path;
      }
      return window.URL.createObjectURL(file);
    },
    fileOnClick(index, file) {
      if (!this.fileClick(index, file, this.files)) {
        return;
      }
      //點擊不下載
      if (!this.downLoad) {
        return;
      }
      if (!file.path) {
        this.$message.error("請先上傳文件");
        return;
      }
      this.base.dowloadFile(
        file.path + this.access_token,
        file.name,
        {
          Authorization: this.$store.getters.getToken(),
        },
        this.http.ipAddress
      );
    },
    getText() {
      if (this.img) {
        return "只能上傳圖片,";
      } else if (this.excel) {
        return "只能上傳excel文件,";
      }
    },
    handleClick() {
      this.$refs.input.click();
    },
    handleChange(e) {
      //this.compress開啟圖片压缩,後面根據需要再完善
      // this.clearFiles();
      var result = this.checkFile(e.target.files);
      if (!result) {
        return;
      }

      this.changed = false;
      //如果傳入了FileInfo需要自行處理移除FileInfo
      if (!this.onChange(e.target.files)) {
        return;
      }
      for (let index = 0; index < e.target.files.length; index++) {
        const element = e.target.files[index];
        element.input = true;
      }
      if (!this.multiple) {
        this.files.splice(0);
      }
      this.files.push(...e.target.files);

      this.$refs.input.value = null;
      if (this.autoUpload && result) {
        this.upload(false);
      }
    },
    removeFile(index) {
      //如果傳入了FileInfo需要自行處理移除FileInfo
      //t移除文件
      let removeFile = this.files[index];
      //删除的還没上傳的文件
      if (removeFile.input) {
        this.files.splice(index, 1);
      } else {
        this.fileInfo.splice(index, 1);
      }
      if (!this.removeBefore(index, removeFile, this.fileInfo)) {
        return;
      }
    },
    clearFiles() {
      this.files.splice(0);
    },
    getFiles() {
      return this.files;
    },
    convertToFile(dataurl, filename) {
      let arr = dataurl.split(",");
      let mime = arr[0].match(/:(.*?);/)[1];
      let suffix = mime.split("/")[1];
      let bstr = atob(arr[1]);
      let n = bstr.length;
      let u8arr = new Uint8Array(n);
      while (n--) {
        u8arr[n] = bstr.charCodeAt(n);
      }
      // new File返回File對象 第一個參數是 ArraryBuffer 或 Bolb 或Arrary 第二個參數是文件名
      // 第三個參數是 要放到文件中的内容的 MIME 類型
      return new File([u8arr], `${filename}.${suffix}`, {
        type: mime,
        input: true,
      });
    },
    async compressImg(file) {
      let fileSize = file.size / 1024 / 1024;
      let read = new FileReader();
      read.readAsDataURL(file);
      return new Promise((resolve, reject) => {
        read.onload = (e) => {
          let img = new Image();
          img.src = e.target.result;
          let _this = this;
          img.onload = function () {
            //默認按比例压缩
            let w = this.width;
            let h = this.height;
            let canvas = document.createElement("canvas");
            let ctx = canvas.getContext("2d");
            canvas.setAttribute("width", w);
            canvas.setAttribute("height", h);
            ctx.drawImage(this, 0, 0, w, h);
            let rate = 0.3;
            if (fileSize > 2) {
              rate = 0.1;
            } else if (fileSize > 1) {
              rate = 0.1;
            }
            if (_this.compressMinSize > rate) {
              rate = _this.compressMinSize;
            }
            // rate=1;
            let base64 = canvas.toDataURL("image/jpeg", rate);
            resolve(_this.convertToFile(base64, file.name));
          };
        };
      });
    },
    async uploadOSS() {
      this.http.get("api/alioss/getAccessToken", {}, false).then(async (x) => {
        if (!x.status) return this.$Message.error(x.message);
        let client = new OSS({
          // yourRegion填寫Bucket所在地域。以华东1（杭州）為例，Region填寫為oss-cn-hangzhou。
          region: x.data.region,
          // 從STS服務獲取的临時访問密鑰（AccessKey ID和AccessKey Secret）。
          accessKeyId: x.data.accessKeyId,
          accessKeySecret: x.data.accessKeySecret,
          // 從STS服務獲取的安全令牌（SecurityToken）。
          stsToken: x.data.securityToken,
          // 填寫Bucket名稱。
          bucket: x.data.bucket,
        });
        console.log(this.files);
        for (let index = 0; index < this.files.length; index++) {
          const file = this.files[index];
          if (file.input) {
            let result = await client.put(
              x.data.bucketFolder + "/" + x.data.unique + file.name,
              file
            );
            file.path = result.url;
            file.newName = x.data.unique + file.name;
          }
        }

        this.fileInfo.splice(0);
        // }
        let _files = this.files.map((file) => {
          return {
            name: file.newName || file.name,
            path: file.path,
          };
        });
        this.fileInfo.push(..._files);
        //2021.09.25修複文件上傳後不能同時下載的問題
        this.files = _files;
      });
      return;
    },
    async upload(vail) {
      if (vail && !this.checkFile()) return false;
      if (!this.url) {
        return this.$message.error("没有配置好Url");
      }
      if (!this.files || this.files.length == 0) {
        return this.$message.error("請選擇文件");
      }
      //增加上傳時自定義參數，後台使用獲取Utilities.HttpContext.Current.Request.Query["字段"]
      let params = {};
      if (!this.uploadBefore(this.files, params)) {
        return;
      }
      let paramText = "";
      if (Object.keys(params).length) {
        paramText = "?1=1";
        for (const key in params) {
          let value = params[key];
          if (typeof value == "object") {
            value = JSON.stringify(value);
          }
          paramText += `&${key}=${value}`;
        }
      }

      this.loadingStatus = true;
      this.loadText = "上傳中..";
      if (window.oss && window.oss.ali.use) {
        await this.uploadOSS();
        this.loadingStatus = false;
        this.loadText = "上傳文件";
        if (!this.uploadAfter({ status: true }, this.files)) {
          this.changed = false;
          return;
        } else {
          this.changed = true;
        }
        this.$message.success("上傳成功");
        return;
      }

      var forms = new FormData();
      for (let index = 0; index < this.files.length; index++) {
        let file = this.files[index];
        if (file.input) {
          //2023.07.10暫時屏蔽圖片压缩
          //let name = file.name.split('.');
          //name = name[name.length - 1].toLocaleLowerCase();
          //let isImg = this.imgTypes.indexOf(name) != -1;
          // if (isImg && (name == 'jpg' || name == 'jpeg')) {
          //   //>200KB的開啟压缩
          //   if (isImg && file.size / 1024 / 1024 > 0.2) {
          //     console.log('压缩前' + file.size);
          //     file = await this.compressImg(file);
          //     file.compress = true;
          //     this.files[index] = file;
          //     this.files[index].input = true;
          //     console.log('压缩後' + file.size);
          //   }
          // }
          forms.append("fileInput", file, file.name);
        }
      }
      // forms.append("fileInput", this.files);

      this.http
        .post(
          this.url + paramText,
          forms,
          this.autoUpload ? "正在上傳文件" : "",
          //高版本axios這裡必須要指定header
          {
            headers: { "Content-Type": "multipart/form-data" },
          }
        )
        .then(
          (x) => {
            // this.$refs.uploadFile.clearFiles();
            this.loadingStatus = false;
            this.loadText = "上傳文件";
            if (!this.uploadAfter(x, this.files)) {
              this.changed = false;
              return;
            } else {
              this.changed = true;
            }

            this.changed = x.status;
            if (!x.status) {
              this.$message.error(x.message);
              // this.files = null;
              return;
            }
            this.$message.success(x.message);
            //單選清除以前的數據
            //  if (!this.multiple) {
            this.fileInfo.splice(0);
            // }
            let _files = this.files.map((file) => {
              return {
                name: file.name,
                path: file.path || x.data + file.name,
              };
            });
            this.fileInfo.push(..._files);
            //2021.09.25修複文件上傳後不能同時下載的問題
            this.files = _files;
          },
          (error) => {
            this.loadText = "上傳文件";
            this.loadingStatus = false;
          }
        );
    },
    format(file, checkFileType) {
      const format = file.name.split(".").pop().toLocaleLowerCase() || "";
      let fileIcon = "el-icon-document";
      if (this.fileTypes.length > 0 && checkFileType != undefined) {
        if (this.fileTypes.indexOf(format) != -1) {
          return true;
        }
        return false;
      }
      if (
        checkFileType &&
        !(checkFileType instanceof Array) &&
        checkFileType != "img" &&
        checkFileType != "excel"
      ) {
        if (checkFileType.indexOf(format) > -1) {
          return true;
        } else {
          return false;
        }
      }

      if (checkFileType == "img" || this.imgTypes.indexOf(format) > -1) {
        if (checkFileType == "img") {
          if (this.imgTypes.indexOf(format) > -1) {
            return true;
          } else {
            return false;
          }
        }
        fileIcon = "el-icon-picture-outline";
      }
      if (
        ["mp4", "m3u8", "rmvb", "avi", "swf", "3gp", "mkv", "flv"].indexOf(format) > -1
      ) {
        fileIcon = "el-icon-document";
      }
      if (["mp3", "wav", "wma", "ogg", "aac", "flac"].indexOf(format) > -1) {
        fileIcon = "el-icon-document";
      }
      if (["doc", "txt", "docx", "pages", "epub", "pdf"].indexOf(format) > -1) {
        fileIcon = "el-icon-document";
      }
      if (
        checkFileType == "excel" ||
        ["numbers", "csv", "xls", "xlsx"].indexOf(format) > -1
      ) {
        if (checkFileType == "excel") {
          if (["numbers", "csv", "xls", "xlsx"].indexOf(format) > -1) {
            return true;
          } else {
            return false;
          }
        }
        fileIcon = "el-icon-document";
      }
      return fileIcon;
    },
    beforeUpload() {},
    checkFile(inputFiles) {
      const files = this.files;

      if (
        this.multiple &&
        files.length + (inputFiles || []).length > (this.maxFile || 5)
      ) {
        this.$message.error(
          "最多只能選【" +
            (this.maxFile || 5) +
            "】" +
            (this.img ? "張圖片" : "個文件") +
            ""
        );
        return false;
      }
      if (!inputFiles) {
        inputFiles = this.files.filter((x) => {
          return x.input;
        });
      }
      let names = [];
      for (let index = 0; index < inputFiles.length; index++) {
        const file = inputFiles[index];
        if (names.indexOf(file.name) != -1) {
          file.name = "(" + index + ")" + file.name;
        }
        names.push(file.name);
        if (this.img && !this.format(file, "img")) {
          this.$message.error("選擇的文件【" + file.name + "】只能是圖片格式");
          return false;
        }
        if (this.excel && !this.format(file, "excel")) {
          this.$message.error("選擇的文件【" + file.name + "】只能是excel文件");
          return false;
        }
        if (
          this.fileTypes &&
          this.fileTypes.length > 0 &&
          !this.format(file, this.fileTypes)
        ) {
          this.$message.error(
            "選擇的文件【" +
              file.name +
              "】只能是【" +
              this.fileTypes.join(",") +
              "】格式"
          );
          return false;
        }
        if (file.size > (this.maxSize || 50) * 1024 * 1024) {
          this.$message.error(
            "選擇的文件【" + file.name + "】不能超過:" + (this.maxSize || 50) + "M"
          );
          return false;
        }
      }
      return true;
    },
    handleImageError($e) {
      $e.target.src = this.defaultImg;
    },
  },
};
</script>
<style lang="less" scoped>
.upload-list {
  padding-left: 0;
  list-style: none;
  margin: 6px 0;

  .list-file {
    line-height: 20px;
    padding: 2px;
    color: #515a6e;
    border-radius: 4px;
    transition: background-color 0.2s ease-in-out;
    overflow: hidden;
    position: relative;

    font-size: 13px;

    .file-remove {
      display: none;
      right: 0;
      //  margin-left: 50px;
      color: #0e9286;
    }
  }

  .list-file:hover {
    cursor: pointer;

    .file-remove {
      display: initial;
    }

    color: #2d8cf0;
  }
}

.upload-container {
  display: inline-block;
  width: 100%;
  // padding: 10px;

  // min-height: 250px;
  border-radius: 5px;

  .alert {
    margin-top: 43px;
  }

  .button-group > * {
    float: left;
    margin-right: 10px;
  }

  .file-info > span {
    margin-right: 20px;
  }
}

.upload-img {
  display: inline-block;

  .img-item:hover .operation {
    display: block;
  }

  .img-selector {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .img-item,
  .img-selector {
    position: relative;
    cursor: pointer;
    margin: 0 10px 10px 0;
    float: left;
    //width: 65px;
    //height: 65px;
    border: 1px solid #c7c7c7;
    overflow: hidden;
    border-radius: 3px;
    box-sizing: content-box;

    img {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .operation {
      display: none;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;

      .action {
        opacity: 0.6;
        text-align: center;
        background: #151515de;
        font-size: 14px;
        position: absolute;
        z-index: 90;
        width: 100%;
        bottom: 3px;
        bottom: 0;
        color: #ded5d5;
        padding-right: 7px;
        padding-bottom: 3px;
        line-height: 20px;

        .el-icon-view {
          margin: 0 10px;
        }
      }

      .mask {
        opacity: 0.6;
        background: #9e9e9e;
        top: 0;
        width: 100%;
        height: 100%;
        position: absolute;
      }
    }
  }

  .img-selector {
    font-size: 50px;
    text-align: center;

    i {
      position: relative;
      // font-size: 40px;
      color: #6f6f6f;
    }
  }

  // .auto-selector {
  //   .selector {
  //     line-height: 64px;
  //   }
  // }

  .selector {
    color: #a0a0a0;
  }

  .submit-selector {
    .s-btn {
      line-height: 22px;
      font-size: 12px;
      top: -6px;
      // padding: 2px;
      position: relative;
      background: #2db7f5;
      color: white;
    }

    .selector {
      line-height: 50px;
    }

    .readonly {
      background: #8c8c8c;
    }
  }
}

.big-model {
  width: 100%;
  height: 100%;
  position: relative;

  .m-img {
  }

  .mask {
    position: absolute;
    opacity: 0.6;
    background: #eee;
    top: 0;
    width: 100%;
    height: 100%;
    position: absolute;
  }
}

.auto-upload {
  z-index: 9999999;
  width: 100%;
  height: 100%;
  position: fixed;
  top: 0;
  left: 0;

  .j-content {
    text-align: center;
    font-size: 17px;
    top: 40%;
    position: absolute;
    z-index: 999;
    left: 0;
    right: 0;
    width: 240px;
    /* height: 100%; */
    margin: auto;
    background: white;
    /* bottom: 30px; */
    line-height: 50px;
    border-radius: 6px;
    border: 1px solid #d2d2d2;
  }

  .mask {
    cursor: pointer;
    opacity: 0.6;
    width: 100%;
    height: 100%;
    background: #101010;
  }
}
</style>
